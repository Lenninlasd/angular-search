/*! Solr-Heatmap-Client created on 08-07-2016 */
angular.module("SolrHeatmapApp",["ui.bootstrap"]),angular.module("SolrHeatmapApp").controller("BackgroundLayerController",["MapService","$scope",function(a,b){var c=this;c.layers={},c.selectedLayer={},c.$on("mapReady",function(a,b){c.layers=b.getLayers().getArray(),c.selectedLayer={name:c.getBackgroundLayers()[0].get("name")}}),c.isBackgroundLayer=function(a){var b=!1;return a.get("backgroundLayer")&&(b=!0),b},c.setBackgroundLayer=function(a){angular.forEach(c.getBackgroundLayers(),function(b){b===a?(a.setVisible(!0),c.selectedLayer={name:a.get("name")}):b.setVisible(!1)})},c.getBackgroundLayers=function(){var b=a.getMap().getLayers().getArray();return b.filter(function(a){return!!a.get("backgroundLayer")})}}]),angular.module("SolrHeatmapApp").controller("DatePickerController",["HeatMapSourceGenerator","$scope",function(a,b){var c=this;c.initialDateOptions={minDate:new Date("2000-01-01"),maxDate:new Date("2016-12-31")},c.dateOptions={minDate:a.getSearchObj().minDate,maxDate:a.getSearchObj().maxDate,startingDay:1,showWeeks:!1},c.openStartDate=function(){c.startDate.opened=!0,c.dateOptions.minDate=c.initialDateOptions.minDate,c.dateOptions.maxDate=c.dte},c.openEndDate=function(){c.endDate.opened=!0,c.dateOptions.maxDate=c.initialDateOptions.maxDate,c.dateOptions.minDate=c.dts},c.startDate={opened:!1},c.endDate={opened:!1},c.setInitialDates=function(){c.dts=c.dateOptions.minDate,c.dte=c.dateOptions.maxDate},c.setInitialDates(),c.onChangeStartDate=function(){c.setDateRange(c.dts,c.dte),a.performSearch()},c.onChangeEndDate=function(){c.setDateRange(c.dts,c.dte),a.performSearch()},c.setDateRange=function(b,c){a.setMinDate(b),a.setMaxDate(c)}}]),angular.module("SolrHeatmapApp").controller("ExportController",["HeatMapSourceGenerator","$scope",function(a,b){b.startExport=function(){a.startCsvExport()}}]),angular.module("SolrHeatmapApp").controller("MainController",["Map","HeatMapSourceGenerator","$http","$scope","$rootScope",function(a,b,c,d,e){var f=this;solrHeatmapApp=f,c.get("./config/appConfig.json").success(function(c,d,f,g){if(!c||!c.mapConfig)throw"Could not find the mapConfig";var h=c.mapConfig,i=c.appConfig,j=c.bopwsConfig;a.init({mapConfig:h}),solrHeatmapApp.appConfig=i,solrHeatmapApp.initMapConf=h,solrHeatmapApp.bopwsConfig=j,e.$broadcast("mapReady",a.getMap()),a.getMap().on("moveend",function(a){b.performSearch()}),a.getMap().getView().on("change:resolution",function(b){var c=a.getLayersBy("name","HeatMapLayer");if(c&&c.length>0){var d=500*b.target.getResolution(),e=c[0];d>15&&(d=15),e.setRadius(d),e.setBlur(2*d)}})}).error(function(a,b,c,d){throw"Error while loading the config.json"})}]),angular.module("SolrHeatmapApp").controller("ResultCounterController",["$scope",function(a){a.$on("setCounter",function(b,c){c<1&&(c="No results found"),a.counter=c})}]),angular.module("SolrHeatmapApp").controller("SearchController",["HeatMapSourceGenerator","$scope","$window",function(a,b,c){function d(a){return c.event?a.keyCode:a.which}b.searchInput="",b.onKeyPress=function(a){13===d(a)&&b.doSearch()},b.doSearch=function(){a.setSearchText(b.searchInput),a.performSearch()},b.resetSearchInput=function(){b.searchInput="",a.setSearchText(""),a.performSearch()}}]),angular.module("SolrHeatmapApp").factory("HeatMapSourceGenerator",["Map","$rootScope","$filter","$window","$document","$http",function(a,b,c,d,e,f){function g(a){v.searchText=a}function h(a){v.minDate=a}function i(a){v.maxDate=a}function j(){return v}function k(){var b=a.getMap(),c=b.getView().getProjection().getCode(),d=b.getView().calculateExtent(b.getSize()),e=ol.proj.transformExtent(d,c,"EPSG:4326"),f={};if(d&&e){var g=t(e),h=g[1],i=g[3],j=g[0],k=g[2];f={minX:h,maxX:i,minY:j,maxY:k}}return f}function l(){var c={},e=this.getTweetsSearchQueryParameters(this.getGeospatialFilter());e["a.hm.limit"]=solrHeatmapApp.bopwsConfig.heatmapFacetLimit,e&&(c={url:solrHeatmapApp.appConfig.tweetsSearchBaseUrl,method:"GET",params:e},f(c).success(function(c,d,e,f){c&&c["a.hm"]&&(a.createOrUpdateHeatMapLayer(c["a.hm"]),b.$broadcast("setCounter",c["a.matchDocs"]))}).error(function(a,b,c,e){d.alert("An error occured while reading heatmap")}))}function m(){var a={},b=this.getTweetsSearchQueryParameters(this.getGeospatialFilter());b["d.docs.limit"]=solrHeatmapApp.bopwsConfig.csvDocsLimit,b&&(a={url:solrHeatmapApp.appConfig.tweetsExportBaseUrl,method:"GET",params:b},f(a).success(function(a,b,c,d){var f=angular.element("<a/>");f.css({display:"none"}),angular.element(e.body).append(f),f.attr({href:"data:attachment/csv;charset=utf-8,"+encodeURI(a),target:"_blank",download:"bop_export.csv"})[0].click(),f.remove()}).error(function(a,b,c,e){d.alert("An error occured while exporting csv data")}))}function n(a){var b,c=this.getSearchObj();b=0===c.searchText.length?"*":c.searchText;var d={"q.text":b,"q.time":"["+this.getFormattedDateString(c.minDate)+" TO "+this.getFormattedDateString(c.maxDate)+"]","q.geo":"["+a.minX+","+a.minY+" TO "+a.maxX+","+a.maxY+"]"};return d}function o(a,b,c){if(c<b){var d=b;b=c,c=d}return Math.min(Math.max(b,a),c)}function p(a){return a<-180||a>180}function q(a){return a<-90||a>90}function r(a){return o(a,-180,180)}function s(a){return o(a,-90,90)}function t(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=Math.min(d-b,360),g=Math.min(e-c,180);return p(b)?(b=r(b),d=b+f):p(d)&&(d=r(d),b=d-f),q(c)?(c=s(c),e=c+g):q(e)&&(e=s(e),c=e-g),[b,c,d,e]}function u(a){return a.getFullYear()+"-"+("0"+(a.getMonth()+1)).slice(-2)+"-"+("0"+a.getDate()).slice(-2)}var v={minDate:new Date("2000-01-01"),maxDate:new Date("2016-12-31"),searchText:""},w={getGeospatialFilter:k,getTweetsSearchQueryParameters:n,performSearch:l,startCsvExport:m,setSearchText:g,setMinDate:h,setMaxDate:i,getFormattedDateString:u,getSearchObj:j};return w}]),angular.module("SolrHeatmapApp").factory("Map",["$rootScope","$filter","$document",function(a,b,c){function d(a){var b=angular.extend(p.view,a.mapConfig.view),c=angular.extend(p.renderer,a.mapConfig.renderer),d=a.mapConfig.layers;o=new ol.Map({controls:ol.control.defaults().extend([new ol.control.ScaleLine,new ol.control.ZoomSlider]),interactions:ol.interaction.defaults(),layers:e(d),renderer:angular.isString(c)?c:void 0,target:"map",view:new ol.View({center:angular.isArray(b.center)?b.center:void 0,maxZoom:angular.isNumber(b.maxZoom)?b.maxZoom:void 0,minZoom:angular.isNumber(b.minZoom)?b.minZoom:void 0,projection:angular.isString(b.projection)?b.projection:void 0,resolution:angular.isString(b.resolution)?b.resolution:void 0,resolutions:angular.isArray(b.resolutions)?b.resolutions:void 0,rotation:angular.isNumber(b.rotation)?b.rotation:void 0,zoom:angular.isNumber(b.zoom)?b.zoom:void 0,zoomFactor:angular.isNumber(b.zoomFactor)?b.zoomFactor:void 0})})}function e(a){var b,c=[];return angular.isArray(a)&&angular.forEach(a,function(a){"TileWMS"===a.type&&(b=new ol.layer.Tile({name:a.name,backgroundLayer:a.backgroundLayer,displayInLayerPanel:a.displayInLayerPanel,source:new ol.source.TileWMS({attributions:[new ol.Attribution({html:a.attribution})],crossOrigin:a.crossOrigin,logo:a.logo,params:a.params,ratio:a.ratio,resolutions:a.resoltions,url:a.url}),opacity:a.opacity,visible:a.visible})),"ImageWMS"===a.type&&(b=new ol.layer.Image({name:a.name,backgroundLayer:a.backgroundLayer,displayInLayerPanel:a.displayInLayerPanel,source:new ol.source.ImageWMS({attributions:[new ol.Attribution({html:a.attribution})],crossOrigin:a.crossOrigin,logo:a.logo,params:a.params,resolutions:a.resoltions,url:a.url}),opacity:a.opacity,visible:a.visible})),c.push(b)}),c}function f(a,c){var d=this.getMap().getLayers().getArray();return b("filter")(d,function(b){return b.get(a)===c})}function g(a){var c=solrHeatmapApp.map.getInteractions().getArray();return b("filter")(c,function(b){return b instanceof a})}function h(a,c){return b("filter")(a,function(a){return a.type_===c})}function i(){return o}function j(b){var d=b.coordinate,e=o.forEachFeatureAtPixel(b.pixel,function(a,b){return a}),f="",g=c[0].getElementById("popup"),h=c[0].getElementById("popup-content"),i=c[0].getElementById("popup-closer"),j=new ol.Overlay({element:g,autoPan:!0,autoPanAnimation:{duration:250}});if(i.onclick=function(){return j.setPosition(void 0),i.blur(),!1},o.getOverlays().clear(),o.addOverlay(j),e){var k=e.get("origVal");k&&a.$broadcast("featureInfoLoaded",k)}q.$on("featureInfoLoaded",function(a,b){f+="<h5>Number of elements: </h5>"+k,h.innerHTML=f;var c=solrHeatmapApp.map.getOverlays().getArray()[0];c&&c.setPosition(d)})}function k(a){var b,c=this.createHeatMapSource(a),d=this.getLayersBy("name","HeatMapLayer");if(d&&d.length>0){var e=d[0],f=e.getSource();f&&f.clear(),e.setSource(c)}else b=new ol.layer.Heatmap({name:"HeatMapLayer",source:c,radius:10}),o.addLayer(b)}function l(a){var b,c,d=a.counts_ints2D,e=(a.gridLevel,a.columns),f=a.rows,g=a.minX,h=a.minY,i=a.maxX,j=a.maxY,k=a.projection,l=i-g,m=j-h,n=l/e,p=m/f,q=[];if(!d)return null;b=this.heatmapMinMax(d,f,e);for(var r=0;r<f;r++)for(var s=0;s<e;s++){var t,u,v,w,x=d[d.length-r-1][s];if(x&&null!==x){u=h+r*p+.5*p,t=g+s*n+.5*n,w=ol.proj.transform([t,u],k,o.getView().getProjection().getCode()),v=new ol.Feature({geometry:new ol.geom.Point(w)});var y=this.rescaleHeatmapValue(x,b);v.set("weight",y),v.set("origVal",x),q.push(v)}}return c=new ol.source.Vector({features:q,useSpatialIndex:!0})}function m(a,b,c){for(var d=-1,e=Number.MAX_VALUE,f=0;f<b;f++){var g=a[f];null===g&&(a[f]=g=[]);for(var h=0;h<c;h++)null===g[h]&&(g[h]=-1),g[h]>d&&(d=g[h]),g[h]<e&&g[h]>-1&&(e=g[h])}return[e,d]}function n(a,b){return null===a?0:a===-1?-1:0===a?0:b[1]-b[0]===0?0:(a-b[0])/(b[1]-b[0])}var o={},p={renderer:"canvas",view:{center:[0,0],projection:"EPSG:3857",zoom:2}},q=a,r={init:d,getMap:i,getLayersBy:f,getInteractionsByClass:g,getInteractionsByType:h,displayFeatureInfo:j,createOrUpdateHeatMapLayer:k,createHeatMapSource:l,heatmapMinMax:m,rescaleHeatmapValue:n};return r}]);