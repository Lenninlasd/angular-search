/*! Solr-Heatmap-Client created on 12-09-2016 */
!function(){angular.module("SolrHeatmapApp",["ui.bootstrap","rzModule","search_components"])}(),function(){function datePicker(){return{controller:datePickerFilterController,templateUrl:"app/components/datepicker/datepicker.html",restrict:"EA"}}function datePickerFilterController($rootScope,HeatMapSourceGeneratorService,$uibModal,$scope){function openStartDate(){vm.startDate.opened=!0,vm.dateOptions.minDate=vm.initialDateOptions.minDate,vm.dateOptions.maxDate=vm.dte}function openEndDate(){vm.endDate.opened=!0,vm.dateOptions.maxDate=vm.initialDateOptions.maxDate,vm.dateOptions.minDate=vm.dts}function onChangeDatepicker(){vm.dateString=getFormattedDateString(vm.dts,vm.dte),performDateSearch()}function getFormattedDateString(minDate,maxDate){return"["+minDate.toISOString().replace(".000Z","")+" TO "+maxDate.toISOString().replace(".000Z","")+"]"}function stringToDate(dateString){var dateArray=dateString.split(" TO ");return angular.isString(dateString)&&2===dateArray.length?(dateArray[0]=new Date(dateArray[0].slice(1,11)),dateArray[1]=new Date(dateArray[1].slice(0,10)),"Invalid Date"===dateArray[0]||"Invalid Date"===dateArray[0]?null:dateArray):null}function onSubmitDateText(){var dateArray=stringToDate(vm.dateString);null!==dateArray?(vm.dts=dateArray[0],vm.dte=dateArray[1],performDateSearch()):vm.dateString=getFormattedDateString(vm.dts,vm.dte)}function showInfo(){$uibModal.open({animation:!0,templateUrl:"infoPopup.html",controller:"InfoWindowController",size:"lg",resolve:{infoMsg:function(){return solrHeatmapApp.instructions.datepicker.instruction},toolName:function(){return solrHeatmapApp.instructions.datepicker.toolTitle}}})}function setHistogram(event,dataHistogram){1===vm.slider.options.ceil||vm.slider.changeTime===!1?(vm.slider.counts=dataHistogram.counts,vm.slider.options.ceil=vm.slider.maxValue=dataHistogram.counts.length-1,dataHistogram.slider=vm.slider,$rootScope.$broadcast("setHistogramRangeSlider",dataHistogram)):(vm.slider.changeTime=!1,$rootScope.$broadcast("changeSlider",vm.slider))}function slideEnded(){var minKey=vm.slider.minValue,maxKey=vm.slider.maxValue;vm.dts=new Date(vm.slider.counts[minKey].value),vm.dte=new Date(vm.slider.counts[maxKey].value),vm.dateString=getFormattedDateString(vm.dts,vm.dte),performDateSearch()}function performDateSearch(){HeatMapSourceGeneratorService.filterObj.setTextDate(vm.dateString),vm.slider.changeTime=!0,HeatMapSourceGeneratorService.performSearch()}function defaultSliderValue(){return{minValue:0,maxValue:1,changeTime:!1,options:{floor:0,ceil:1,step:1,noSwitching:!0,hideLimitLabels:!0,getSelectionBarColor:function(){return"#3da9ca"},translate:function(){return""}}}}var vm=$scope;vm.initialDateOptions={minDate:new Date("2013-03-01"),maxDate:new Date("2013-04-01")},vm.dateOptions={minDate:HeatMapSourceGeneratorService.filterObj.getSearchObj().minDate,maxDate:HeatMapSourceGeneratorService.filterObj.getSearchObj().maxDate,startingDay:1,showWeeks:!1},vm.dateString=getFormattedDateString(vm.dateOptions.minDate,vm.dateOptions.maxDate),vm.startDate={opened:!1},vm.endDate={opened:!1},vm.onChangeDatepicker=onChangeDatepicker,vm.showInfo=showInfo,vm.openEndDate=openEndDate,vm.openStartDate=openStartDate,vm.onSubmitDateText=onSubmitDateText,vm.slider=defaultSliderValue(),vm.setInitialDates=function(){vm.dts=vm.dateOptions.minDate,vm.dte=vm.dateOptions.maxDate},vm.setInitialDates(),vm.$on("setHistogram",setHistogram),vm.$on("slideEnded",slideEnded)}angular.module("search_datepicker_component",[]).directive("datePicker",datePicker),datePickerFilterController.$inject=["$rootScope","HeatMapSourceGenerator","$uibModal","$scope"]}(),function(){function timeHistogram(){function link(scope,element,attr){function makeHistogram(histogram){function findHistogramMaxValue(){histogram.maxValue=Math.max.apply(null,histogram.counts.map(function(obj){return obj.count}))}function renderingSvgBars(minValue,maxValue){function renderSvgBar(bar,barKey){var height=0===histogram.maxValue?0:barsheight*bar.count/histogram.maxValue,y=barsheight-height,translate=rectWidth*barKey,color=getColor(barKey,minValue,maxValue);return'<g transform="translate('+translate+', 0)">  <rect width="'+rectWidth+'" height="'+height+'" y="'+y+'" fill="'+color+'"></rect></g>'}function getColor(barkey,minvalue,maxvalue){return barkey>=minvalue&&barkey<=maxvalue?"#2e6da4":"#E3E3E3"}if(histogram.counts){minValue=minValue||0,maxValue=maxValue||histogram.counts.length-1,histogram.bars=document.getElementById(scope.barId);var barsheight=60,rectWidth=histogram.bars.offsetWidth/histogram.counts.length,svgRect=histogram.counts.map(renderSvgBar);histogram.bars.innerHTML='<svg width="100%" height="'+barsheight+'">'+svgRect.join("")+"</svg>"}}return findHistogramMaxValue(),renderingSvgBars}var renderSvgBars;scope.barId=attr.barid,scope.$on("setHistogramRangeSlider",function(even,histogram){(renderSvgBars=makeHistogram(histogram))()}),scope.$on("changeSlider",function(event,slider){renderSvgBars(slider.minValue,slider.maxValue)})}var directive={template:'<div class="bar-graph" id="{{barId}}" style="min-width: 400px";></div>',restrict:"EA",link:link};return directive}angular.module("search_timehistogram_component",[]).directive("timeHistogram",timeHistogram)}(),function(){angular.module("search_components",["search_timehistogram_component","search_datepicker_component","search_tweetlist_component"])}(),function(){function tweetlist(){return{controller:tweetlistController,restrict:"EA",templateUrl:"app/components/tweetlist/tweetlist.html"}}function tweetlistController($scope){function setTweetList(event,tweetList){vm.tweetList=tweetList,vm.tweetList.exist=!0}var vm=$scope;vm.tweetList=[],vm.tweetList.exist=!1,vm.$on("setTweetList",setTweetList)}angular.module("search_tweetlist_component",[]).directive("tweetlist",tweetlist),tweetlistController.$inject=["$scope"]}(),function(){angular.module("SolrHeatmapApp").controller("BackgroundLayerController",["MapService","$scope",function(MapService,$scope){var vm=this;vm.layers={},vm.selectedLayer={},vm.$on("mapReady",function(event,map){vm.layers=map.getLayers().getArray(),vm.selectedLayer={name:vm.getBackgroundLayers()[0].get("name")}}),vm.isBackgroundLayer=function(layer){var isBackgroundLayer=!1;return layer.get("backgroundLayer")&&(isBackgroundLayer=!0),isBackgroundLayer},vm.setBackgroundLayer=function(layer){angular.forEach(vm.getBackgroundLayers(),function(bgLayer){bgLayer===layer?(layer.setVisible(!0),vm.selectedLayer={name:layer.get("name")}):bgLayer.setVisible(!1)})},vm.getBackgroundLayers=function(){var layers=MapService.getMap().getLayers().getArray();return layers.filter(function(l){return!!l.get("backgroundLayer")})}}])}(),function(){angular.module("SolrHeatmapApp").controller("ExportController",["HeatMapSourceGenerator","$uibModal","$scope",function(HeatMapSourceGeneratorService,$uibModal,$scope){$scope["export"]={numDocuments:1,options:{floor:1,ceil:1e4,step:1}},$scope.startExport=function(){var numDocs=$scope["export"].numDocuments;HeatMapSourceGeneratorService.startCsvExport(numDocs)},$scope.showInfo=function(){$uibModal.open({animation:!0,templateUrl:"infoPopup.html",controller:"InfoWindowController",size:"lg",resolve:{infoMsg:function(){return solrHeatmapApp.instructions["export"].instruction},toolName:function(){return solrHeatmapApp.instructions["export"].toolTitle}}})}}])}(),function(){angular.module("SolrHeatmapApp").controller("GeospatialFilterController",["$scope","$uibModal",function($scope,$uibModal){$scope.filterString="[-90,-180 TO 90,180]",$scope.showInfo=function(){$uibModal.open({animation:!0,templateUrl:"infoPopup.html",controller:"InfoWindowController",size:"lg",resolve:{infoMsg:function(){return solrHeatmapApp.instructions.geospatialsearch.instruction},toolName:function(){return solrHeatmapApp.instructions.geospatialsearch.toolTitle}}})},$scope.updateFilterString=function(str){$scope.filterString=str}}])}(),function(){angular.module("SolrHeatmapApp").controller("InfoWindowController",function($scope,$uibModalInstance,infoMsg,toolName){$scope.infoMsg=infoMsg,$scope.toolName=toolName,$scope.ok=function(){$uibModalInstance.close()}})}(),function(){angular.module("SolrHeatmapApp").controller("MainController",["Map","HeatMapSourceGenerator","$http","$scope","$rootScope",function(MapService,HeatMapSourceGeneratorService,$http,$scope,$rootScope){var vm=this;vm.response=function(data,status,headers,config){if(!data||!data.mapConfig)throw new Error("Could not find the mapConfig");var mapConf=data.mapConfig,appConf=data.appConfig,bopwsConfig=data.bopwsConfig,instructions=data.instructions;MapService.init({mapConfig:mapConf}),solrHeatmapApp.appConfig=appConf,solrHeatmapApp.initMapConf=mapConf,solrHeatmapApp.bopwsConfig=bopwsConfig,solrHeatmapApp.instructions=instructions,$rootScope.$broadcast("mapReady",MapService.getMap()),MapService.getMap().getView().on("change:resolution",function(evt){var existingHeatMapLayers=MapService.getLayersBy("name","HeatMapLayer");if(existingHeatMapLayers&&existingHeatMapLayers.length>0){var radius=500*evt.target.getResolution(),hmLayer=existingHeatMapLayers[0];radius>15&&(radius=15),hmLayer.setRadius(radius),hmLayer.setBlur(2*radius)}MapService.checkBoxOfTransformInteraction()}),MapService.getMap().on("moveend",function(evt){HeatMapSourceGeneratorService.performSearch()}),MapService.getInteractionsByClass(ol.interaction.Transform)[0].on(["translateend","scaleend"],function(e){HeatMapSourceGeneratorService.performSearch()})},vm.badResponse=function(data,status,headers,config){throw new Error("Error while loading the config.json")},solrHeatmapApp=vm,$http.get("./config/appConfig.json").success(solrHeatmapApp.response).error(solrHeatmapApp.badResponse)}])}(),function(){angular.module("SolrHeatmapApp").controller("ResultCounterController",["$scope",function($scope){$scope.$on("setCounter",function(e,data){data<1&&(data="No results found"),$scope.counter=data})}])}(),function(){angular.module("SolrHeatmapApp").controller("SearchController",["Map","HeatMapSourceGenerator","$scope","$uibModal","$controller","$window",function(MapService,HeatMapSourceGeneratorService,$scope,$uibModal,$controller,$window){function getKeyboardCodeFromEvent(keyEvt){return $window.event?keyEvt.keyCode:keyEvt.which}$scope.searchInput="",$scope.onKeyPress=function($event){13===getKeyboardCodeFromEvent($event)&&$scope.doSearch()},$scope.doSearch=function(){HeatMapSourceGeneratorService.filterObj.setSearchText($scope.searchInput),HeatMapSourceGeneratorService.performSearch()},$scope.resetSearchInput=function(){$scope.searchInput="",HeatMapSourceGeneratorService.filterObj.setSearchText(""),HeatMapSourceGeneratorService.performSearch(),MapService.resetMap();var ctrlViewModelNew=$scope.$new();$controller("DatePickerController",{$scope:ctrlViewModelNew}),ctrlViewModelNew.setInitialDates()},$scope.showInfo=function(){$uibModal.open({animation:!0,templateUrl:"infoPopup.html",controller:"InfoWindowController",size:"lg",resolve:{infoMsg:function(){return solrHeatmapApp.instructions.textsearch.instruction},toolName:function(){return solrHeatmapApp.instructions.textsearch.toolTitle}}})}}])}(),function(){angular.module("SolrHeatmapApp").controller("UserFilterController",["HeatMapSourceGenerator","$scope","$uibModal",function(HeatMapSourceGeneratorService,$scope,$uibModal){function userSearch(){HeatMapSourceGeneratorService.filterObj.setUser($scope.userfilterInput),HeatMapSourceGeneratorService.performSearch()}function showInfo(){$uibModal.open({animation:!0,templateUrl:"infoPopup.html",controller:"InfoWindowController",size:"lg",resolve:{infoMsg:function(){return solrHeatmapApp.instructions.userfilter.instruction},toolName:function(){return solrHeatmapApp.instructions.userfilter.toolTitle}}})}$scope.userSearch=userSearch,$scope.showInfo=showInfo}])}(),function(){angular.module("SolrHeatmapApp").factory("HeatMapSourceGenerator",["Map","$rootScope","$controller","$filter","$window","$document","$http",function(MapService,$rootScope,$controller,$filter,$window,$document,$http){function filterMethods(){function setSearchText(val){searchObj.searchText=0===val.length?null:val}function setUser(val){searchObj.user=0===val.length?null:val}function setTextDate(val){searchObj.textDate=0===val.length?null:val}function getSearchObj(){return searchObj}function setHistogramCount(val){searchObj.histogramCount=angular.isArray(val)&&0!==val.length?val:[]}var searchObj={minDate:new Date("2013-03-10"),maxDate:new Date("2013-03-21"),textDate:null,searchText:null,user:null,histogramCount:[]};return{getSearchObj:getSearchObj,setSearchText:setSearchText,setUser:setUser,setTextDate:setTextDate,setHistogramCount:setHistogramCount}}function clamp(num,min,max){if(max<min){var tmp=min;min=max,max=tmp}return Math.min(Math.max(min,num),max)}function outsideLonRange(lon){return lon<-180||lon>180}function outsideLatRange(lat){return lat<-90||lat>90}function clampLon(lon){return clamp(lon,-180,180)}function clampLat(lat){return clamp(lat,-90,90)}function normalize(extent){var minX=extent[0],minY=extent[1],maxX=extent[2],maxY=extent[3],width=Math.min(maxX-minX,360),height=Math.min(maxY-minY,180);return outsideLonRange(minX)?(minX=clampLon(minX),maxX=minX+width):outsideLonRange(maxX)&&(maxX=clampLon(maxX),minX=maxX-width),outsideLatRange(minY)?(minY=clampLat(minY),maxY=minY+height):outsideLatRange(maxY)&&(maxY=clampLat(maxY),minY=maxY-height),[minX,minY,maxX,maxY]}function getGeospatialFilter(){var currentBbox,currentBboxExtentWgs84,map=MapService.getMap(),viewProj=map.getView().getProjection().getCode(),extent=map.getView().calculateExtent(map.getSize()),extentWgs84=ol.proj.transformExtent(extent,viewProj,"EPSG:4326"),transformInteractionLayer=MapService.getLayersBy("name","TransformInteractionLayer")[0],geoFilter={};if(!transformInteractionLayer)return null;if(currentBbox=transformInteractionLayer.getSource().getFeatures()[0],currentBboxExtentWgs84=ol.proj.transformExtent(currentBbox.getGeometry().getExtent(),viewProj,"EPSG:4326"),map.getView().getZoom()<=1&&(extentWgs84=[-180,-90,180,90]),extent&&extentWgs84){var normalizedExtentMap=normalize(extentWgs84),normalizedExtentBox=normalize(currentBboxExtentWgs84),minX=normalizedExtentMap[1],maxX=normalizedExtentMap[3],minY=normalizedExtentMap[0],maxY=normalizedExtentMap[2];geoFilter.hmFilter={minX:minX,maxX:maxX,minY:minY,maxY:maxY},minX=normalizedExtentBox[1],maxX=normalizedExtentBox[3],minY=normalizedExtentBox[0],maxY=normalizedExtentBox[2],geoFilter.queryGeo={minX:minX,maxX:maxX,minY:minY,maxY:maxY};var ctrlViewModelNew=angular.element("[ng-controller=GeospatialFilterController]").scope();$controller("GeospatialFilterController",{$scope:ctrlViewModelNew}),ctrlViewModelNew.updateFilterString("["+parseFloat(Math.round(100*minX)/100).toFixed(2)+","+parseFloat(Math.round(100*minY)/100).toFixed(2)+" TO "+parseFloat(Math.round(100*maxX)/100).toFixed(2)+","+parseFloat(Math.round(100*maxY)/100).toFixed(2)+"]")}return geoFilter}function performSearch(){var config={},spatialFilters=this.getGeospatialFilter(),params=this.getTweetsSearchQueryParameters(spatialFilters.queryGeo,spatialFilters.hmFilter);params["a.hm.limit"]=solrHeatmapApp.bopwsConfig.heatmapFacetLimit,params&&null!==spatialFilters?(config={url:solrHeatmapApp.appConfig.tweetsSearchBaseUrl,method:"GET",params:params},$http(config).success(function(data,status,headers,cfg){data&&data["a.hm"]&&(MapService.createOrUpdateHeatMapLayer(data["a.hm"]),$rootScope.$broadcast("setCounter",data["a.matchDocs"]),$rootScope.$broadcast("setHistogram",data["a.time"]),$rootScope.$broadcast("setTweetList",data["d.docs"]),methods.filterObj.setHistogramCount(data["a.time"].counts))}).error(function(data,status,headers,cfg){$window.alert("An error occured while reading heatmap data")})):$window.alert("Spatial filter could not be computed.")}function startCsvExport(numberOfDocuments){var config={},spatialFilters=this.getGeospatialFilter(),params=this.getTweetsSearchQueryParameters(spatialFilters.queryGeo,spatialFilters.hmFilter);params["d.docs.limit"]=angular.isNumber(numberOfDocuments)?numberOfDocuments:solrHeatmapApp.bopwsConfig.csvDocsLimit,params&&null!==spatialFilters?(config={url:solrHeatmapApp.appConfig.tweetsExportBaseUrl,method:"GET",params:params},$http(config).success(function(data,status,headers,cfg){var anchor=angular.element("<a/>");anchor.css({display:"none"}),angular.element($document.body).append(anchor),anchor.attr({href:"data:attachment/csv;charset=utf-8,"+encodeURI(data),target:"_blank",download:"bop_export.csv"})[0].click(),anchor.remove()}).error(function(data,status,headers,cfg){$window.alert("An error occured while exporting csv data")})):$window.alert("Spatial filter could not be computed.")}function getTweetsSearchQueryParameters(bounds){var reqParamsUi=methods.filterObj.getSearchObj(),dx=bounds.maxX-bounds.minX,dy=bounds.maxY-bounds.minY,minInnerX=bounds.minX+(1-solrHeatmapApp.appConfig.ratioInnerBbox)*dx,maxInnerX=bounds.minX+solrHeatmapApp.appConfig.ratioInnerBbox*dx,minInnerY=bounds.minY+(1-solrHeatmapApp.appConfig.ratioInnerBbox)*dy,maxInnerY=bounds.minY+solrHeatmapApp.appConfig.ratioInnerBbox*dy,params={"q.text":reqParamsUi.searchText,"q.user":reqParamsUi.user,"q.time":timeTextFormat(reqParamsUi.textDate,reqParamsUi.minDate,reqParamsUi.maxDate),"q.geo":"["+bounds.minX+","+bounds.minY+" TO "+bounds.maxX+","+bounds.maxY+"]","a.hm.filter":"["+minInnerX+","+minInnerY+" TO "+maxInnerX+","+maxInnerY+"]","a.time.limit":"1","a.time.gap":"PT1H","d.docs.limit":"10"};return params}function getFormattedDateString(minDate,maxDate){return"["+minDate.toISOString().replace(".000Z","")+" TO "+maxDate.toISOString().replace(".000Z","")+"]"}function timeTextFormat(textDate,minDate,maxDate){return null===textDate?getFormattedDateString(minDate,maxDate):textDate}var methods={getGeospatialFilter:getGeospatialFilter,getTweetsSearchQueryParameters:getTweetsSearchQueryParameters,performSearch:performSearch,startCsvExport:startCsvExport,getFormattedDateString:getFormattedDateString,filterObj:filterMethods()};return methods}])}(),function(){angular.module("SolrHeatmapApp").factory("Map",["$rootScope","$filter","$document",function($rootScope,$filter,$document){function buildMapLayers(layerConfig){var layer,layers=[];return angular.isArray(layerConfig)&&angular.forEach(layerConfig,function(conf){"TileWMS"===conf.type&&(layer=new ol.layer.Tile({name:conf.name,backgroundLayer:conf.backgroundLayer,displayInLayerPanel:conf.displayInLayerPanel,source:new ol.source.TileWMS({attributions:[new ol.Attribution({html:conf.attribution})],crossOrigin:conf.crossOrigin,logo:conf.logo,params:conf.params,ratio:conf.ratio,resolutions:conf.resoltions,url:conf.url}),opacity:conf.opacity,visible:conf.visible})),"ImageWMS"===conf.type&&(layer=new ol.layer.Image({name:conf.name,backgroundLayer:conf.backgroundLayer,displayInLayerPanel:conf.displayInLayerPanel,source:new ol.source.ImageWMS({attributions:[new ol.Attribution({html:conf.attribution})],crossOrigin:conf.crossOrigin,logo:conf.logo,params:conf.params,resolutions:conf.resoltions,url:conf.url}),opacity:conf.opacity,visible:conf.visible})),layers.push(layer)}),layers}function getMap(){return map}function getLayersBy(key,value){var layers=getMap().getLayers().getArray();return $filter("filter")(layers,function(layer){return layer.get(key)===value})}function getInteractionsByClass(value){var interactions=getMap().getInteractions().getArray();return $filter("filter")(interactions,function(interaction){return interaction instanceof value})}function getInteractionsByType(interactions,type){return $filter("filter")(interactions,function(interaction){return interaction.type_===type})}function displayFeatureInfo(evt){var coord=evt.coordinate,feature=map.forEachFeatureAtPixel(evt.pixel,function(feat,layer){return feat}),msg="",container=$document[0].getElementById("popup"),content=$document[0].getElementById("popup-content"),closer=$document[0].getElementById("popup-closer"),overlay=new ol.Overlay({element:container,autoPan:!0,autoPanAnimation:{duration:250}});if(closer.onclick=function(){return overlay.setPosition(void 0),closer.blur(),!1},map.getOverlays().clear(),map.addOverlay(overlay),feature){var data=feature.get("origVal");data&&$rootScope.$broadcast("featureInfoLoaded",data)}rs.$on("featureInfoLoaded",function(event,dta){msg+="<h5>Number of elements: </h5>"+data,content.innerHTML=msg;var overlayFi=solrHeatmapApp.map.getOverlays().getArray()[0];overlayFi&&overlayFi.setPosition(coord)})}function switchMasks(hmAvailable){var heatMapLayer=getLayersBy("name","HeatMapLayer")[0],heatMapMask=heatMapLayer.getFilters()[0],backgroundLayer=getLayersBy("backgroundLayer",!0)[0],backgroundLayerMask=backgroundLayer.getFilters()[0];backgroundLayerMask.setActive(!hmAvailable),heatMapMask.setActive(hmAvailable)}function heatmapMinMax(heatmap,stepsLatitude,stepsLongitude){for(var max=-1,min=Number.MAX_VALUE,i=0;i<stepsLatitude;i++){var currentRow=heatmap[i];null===currentRow&&(heatmap[i]=currentRow=[]);for(var j=0;j<stepsLongitude;j++)null===currentRow[j]&&(currentRow[j]=-1),currentRow[j]>max&&(max=currentRow[j]),currentRow[j]<min&&currentRow[j]>-1&&(min=currentRow[j])}return[min,max]}function rescaleHeatmapValue(value,minMaxValue){return null===value?0:value===-1?-1:0===value?0:minMaxValue[1]-minMaxValue[0]===0?0:(value-minMaxValue[0])/(minMaxValue[1]-minMaxValue[0])}function createHeatMapSource(hmParams){var minMaxValue,olVecSrc,counts_ints2D=hmParams.counts_ints2D,gridColumns=(hmParams.gridLevel,hmParams.columns),gridRows=hmParams.rows,minX=hmParams.minX,minY=hmParams.minY,maxX=hmParams.maxX,maxY=hmParams.maxY,hmProjection=hmParams.projection,dx=maxX-minX,dy=maxY-minY,sx=dx/gridColumns,sy=dy/gridRows,olFeatures=[];if(!counts_ints2D)return null;minMaxValue=heatmapMinMax(counts_ints2D,gridRows,gridColumns);for(var i=0;i<gridRows;i++)for(var j=0;j<gridColumns;j++){var lon,lat,feat,coords,hmVal=counts_ints2D[counts_ints2D.length-i-1][j];if(hmVal&&null!==hmVal){lat=minY+i*sy+.5*sy,lon=minX+j*sx+.5*sx,coords=ol.proj.transform([lon,lat],hmProjection,map.getView().getProjection().getCode()),feat=new ol.Feature({geometry:new ol.geom.Point(coords)});var scaledValue=rescaleHeatmapValue(hmVal,minMaxValue);feat.set("weight",scaledValue),feat.set("origVal",hmVal),olFeatures.push(feat)}}return olVecSrc=new ol.source.Vector({features:olFeatures,useSpatialIndex:!0})}function createOrUpdateHeatMapLayer(data){var newHeatMapLayer,olVecSrc=createHeatMapSource(data),existingHeatMapLayers=getLayersBy("name","HeatMapLayer"),transformInteractionLayer=getLayersBy("name","TransformInteractionLayer")[0];if(existingHeatMapLayers&&existingHeatMapLayers.length>0){var currHeatmapLayer=existingHeatMapLayers[0],layerSrc=currHeatmapLayer.getSource();layerSrc&&layerSrc.clear(),currHeatmapLayer.setSource(olVecSrc)}else{newHeatMapLayer=new ol.layer.Heatmap({name:"HeatMapLayer",source:olVecSrc,radius:10}),map.addLayer(newHeatMapLayer);var currentBBox=transformInteractionLayer.getSource().getFeatures()[0],mask=new ol.filter.Mask({feature:currentBBox,inner:!1,fill:new ol.style.Fill({color:[255,255,255,.5]})});newHeatMapLayer.addFilter(mask)}switchMasks(null!==olVecSrc)}function setTransactionBBox(extent){var polyNew,transformationLayer=getLayersBy("name","TransformInteractionLayer")[0],vectorSrc=transformationLayer.getSource(),currentBbox=vectorSrc.getFeatures()[0];polyNew=ol.geom.Polygon.fromExtent(extent),currentBbox.setGeometry(polyNew),map.getInteractions().getArray().forEach(function(interaction){interaction instanceof ol.interaction.Transform&&interaction.dispatchEvent("propertychange")})}function generateMaskAndAssociatedInteraction(bboxFeature,fromSrs){var polygon=new ol.Feature(ol.geom.Polygon.fromExtent(bboxFeature)),backGroundLayer=getLayersBy("backgroundLayer",!0)[0];getLayersBy("name","HeatMapLayer")[0];if(fromSrs!==map.getView().getProjection().getCode()){var polygonNew=ol.proj.transformExtent(bboxFeature,fromSrs,map.getView().getProjection().getCode());polygon=new ol.Feature(ol.geom.Polygon.fromExtent(polygonNew))}var vector=new ol.layer.Vector({name:"TransformInteractionLayer",source:new ol.source.Vector,style:new ol.style.Style({fill:new ol.style.Fill({color:[255,255,255,.01]})})});map.addLayer(vector),vector.getSource().addFeature(polygon);var transformInteraction=new ol.interaction.Transform({translate:!0,scale:!0,translateFeature:!1,rotate:!1,stretch:!1});map.addInteraction(transformInteraction);var mask=new ol.filter.Mask({feature:polygon,inner:!1,fill:new ol.style.Fill({color:[255,255,255,.5]})});backGroundLayer.addFilter(mask)}function checkBoxOfTransformInteraction(){for(var transformInteractionLayer=getLayersBy("name","TransformInteractionLayer")[0],mapExtent=map.getView().calculateExtent(map.getSize()),vectorSrc=transformInteractionLayer.getSource(),currentBbox=vectorSrc.getFeatures()[0],needsUpdate=!1,ordArray=currentBbox.getGeometry().getCoordinates()[0],i=0;i<ordArray.length;i++)if(!new ol.geom.Point(ordArray[i]).intersectsExtent(mapExtent)){needsUpdate=!0;break}if(needsUpdate===!0){var minx=mapExtent[0],miny=mapExtent[1],maxx=mapExtent[2],maxy=mapExtent[3],dx=maxx-minx,dy=maxy-miny,minInnerX=minx+(1-solrHeatmapApp.appConfig.ratioInnerBbox)*dx,maxInnerX=minx+solrHeatmapApp.appConfig.ratioInnerBbox*dx,minInnerY=miny+(1-solrHeatmapApp.appConfig.ratioInnerBbox)*dy,maxInnerY=miny+solrHeatmapApp.appConfig.ratioInnerBbox*dy;setTransactionBBox([minInnerX,minInnerY,maxInnerX,maxInnerY])}}function resetMap(){var intitalCenter=solrHeatmapApp.initMapConf.view.center,intitalZoom=solrHeatmapApp.initMapConf.view.zoom;if(intitalZoom&&intitalCenter){var vw=map.getView();vw.setCenter(intitalCenter),vw.setZoom(intitalZoom),setTransactionBBox(solrHeatmapApp.initMapConf.view.extent)}}function init(config){var viewConfig=angular.extend(defaults.view,config.mapConfig.view),rendererConfig=angular.extend(defaults.renderer,config.mapConfig.renderer),layerConfig=config.mapConfig.layers;if(map=new ol.Map({controls:ol.control.defaults().extend([new ol.control.ScaleLine,new ol.control.ZoomSlider]),interactions:ol.interaction.defaults(),layers:buildMapLayers(layerConfig),renderer:angular.isString(rendererConfig)?rendererConfig:void 0,target:"map",view:new ol.View({center:angular.isArray(viewConfig.center)?viewConfig.center:void 0,maxZoom:angular.isNumber(viewConfig.maxZoom)?viewConfig.maxZoom:void 0,minZoom:angular.isNumber(viewConfig.minZoom)?viewConfig.minZoom:void 0,projection:angular.isString(viewConfig.projection)?viewConfig.projection:void 0,resolution:angular.isString(viewConfig.resolution)?viewConfig.resolution:void 0,resolutions:angular.isArray(viewConfig.resolutions)?viewConfig.resolutions:void 0,rotation:angular.isNumber(viewConfig.rotation)?viewConfig.rotation:void 0,zoom:angular.isNumber(viewConfig.zoom)?viewConfig.zoom:void 0,zoomFactor:angular.isNumber(viewConfig.zoomFactor)?viewConfig.zoomFactor:void 0})}),angular.isArray(viewConfig.extent)){var vw=map.getView();vw.set("extent",viewConfig.extent),generateMaskAndAssociatedInteraction(viewConfig.extent,viewConfig.projection)}}var map={},defaults={renderer:"canvas",view:{center:[0,0],projection:"EPSG:3857",zoom:2}},rs=$rootScope,ms={init:init,getMap:getMap,getLayersBy:getLayersBy,getInteractionsByClass:getInteractionsByClass,getInteractionsByType:getInteractionsByType,displayFeatureInfo:displayFeatureInfo,createOrUpdateHeatMapLayer:createOrUpdateHeatMapLayer,generateMaskAndAssociatedInteraction:generateMaskAndAssociatedInteraction,checkBoxOfTransformInteraction:checkBoxOfTransformInteraction,setTransactionBBox:setTransactionBBox,createHeatMapSource:createHeatMapSource,heatmapMinMax:heatmapMinMax,rescaleHeatmapValue:rescaleHeatmapValue,resetMap:resetMap};return ms}])}(),ol.interaction.Transform=function(options){options||(options={});var self=this;ol.interaction.Pointer.call(this,{handleDownEvent:this.handleDownEvent_,handleDragEvent:this.handleDragEvent_,handleMoveEvent:this.handleMoveEvent_,handleUpEvent:this.handleUpEvent_}),this.features_=options.features,this.layers_=options.layers?options.layers instanceof Array?options.layers:[options.layers]:null,this.set("translateFeature",options.translateFeature!==!1),this.set("translate",options.translate!==!1),this.set("stretch",options.stretch!==!1),this.set("scale",options.scale!==!1),this.set("rotate",options.rotate!==!1),this.on("propertychange",function(){this.drawSketch_()}),this.handles_=new ol.Collection,this.overlayLayer_=new ol.layer.Vector({source:new ol.source.Vector({features:this.handles_,useSpatialIndex:!1}),name:"Transform overlay",displayInLayerSwitcher:!1,style:function(feature){return self.style[(feature.get("handle")||"default")+(feature.get("constraint")||"")+(feature.get("option")||"")]}}),this.setDefaultStyle()},ol.inherits(ol.interaction.Transform,ol.interaction.Pointer),ol.interaction.Transform.prototype.Cursors={"default":"auto",select:"pointer",translate:"move",rotate:"move",scale:"ne-resize",scale1:"nw-resize",scale2:"ne-resize",scale3:"nw-resize",scalev:"e-resize",scaleh1:"n-resize",scalev2:"e-resize",scaleh3:"n-resize"},ol.interaction.Transform.prototype.setMap=function(map){this.getMap()&&this.getMap().removeLayer(this.overlayLayer_),ol.interaction.Pointer.prototype.setMap.call(this,map),this.overlayLayer_.setMap(map),this.isTouch=/touch/.test(map.getViewport().className),this.setDefaultStyle()},ol.interaction.Transform.prototype.setActive=function(b){ol.interaction.Pointer.prototype.setActive.call(this,b),b&&this.select(null)},ol.interaction.Transform.prototype.setDefaultStyle=function(){function createStyle(img,stroke,fill){return[new ol.style.Style({image:img,stroke:stroke,fill:fill})]}var stroke=new ol.style.Stroke({color:[255,0,0,1],width:1}),strokedash=new ol.style.Stroke({color:[255,0,0,1],width:1,lineDash:[4,4]}),fill0=new ol.style.Fill({color:[255,0,0,.01]}),fill=new ol.style.Fill({color:[255,255,255,.8]}),circle=new ol.style.RegularShape({fill:fill,stroke:stroke,radius:this.isTouch?12:6,points:15});circle.getAnchor()[0]=this.isTouch?-10:-5;var bigpt=new ol.style.RegularShape({fill:fill,stroke:stroke,radius:this.isTouch?16:8,points:4,angle:Math.PI/4}),smallpt=new ol.style.RegularShape({fill:fill,stroke:stroke,radius:this.isTouch?12:6,points:4,angle:Math.PI/4});this.style={"default":createStyle(bigpt,strokedash,fill0),translate:createStyle(bigpt,stroke,fill),rotate:createStyle(circle,stroke,fill),rotate0:createStyle(bigpt,stroke,fill),scale:createStyle(bigpt,stroke,fill),scale1:createStyle(bigpt,stroke,fill),scale2:createStyle(bigpt,stroke,fill),scale3:createStyle(bigpt,stroke,fill),scalev:createStyle(smallpt,stroke,fill),scaleh1:createStyle(smallpt,stroke,fill),scalev2:createStyle(smallpt,stroke,fill),scaleh3:createStyle(smallpt,stroke,fill)},this.drawSketch_()},ol.interaction.Transform.prototype.setStyle=function(style,olstyle){if(olstyle){olstyle instanceof Array?this.style[style]=olstyle:this.style[style]=[olstyle];for(var i=0;i<this.style[style].length;i++){var im=this.style[style][i].getImage();im&&("rotate"==style&&(im.getAnchor()[0]=-5),this.isTouch&&im.setScale(1.8));var tx=this.style[style][i].getText();tx&&("rotate"==style&&tx.setOffsetX(this.isTouch?14:7),this.isTouch&&tx.setScale(1.8))}this.drawSketch_()}},ol.interaction.Transform.prototype.getFeatureAtPixel_=function(pixel){return this.getMap().forEachFeatureAtPixel(pixel,function(feature,layer){var found=!1;if(!layer){if(feature===this.bbox_)return!1;if(this.handles_.forEach(function(f){f===feature&&(found=!0)}),found)return{feature:feature,handle:feature.get("handle"),constraint:feature.get("constraint"),option:feature.get("option")}}if(this.layers_){for(var i=0;i<this.layers_.length;i++)if(this.layers_[i]===layer)return{feature:feature};return null}return this.features_?(this.features_.forEach(function(f){f===feature&&(found=!0)}),found?{feature:feature}:null):{feature:feature}},this)||{}},ol.interaction.Transform.prototype.drawSketch_=function(center){if(this.overlayLayer_.getSource().clear(),this.feature_)if(center===!0){
if(!this.ispt_){this.overlayLayer_.getSource().addFeature(new ol.Feature({geometry:new ol.geom.Point(this.center_),handle:"rotate0"}));var ext=this.feature_.getGeometry().getExtent(),geom=ol.geom.Polygon.fromExtent(ext),f=this.bbox_=new ol.Feature(geom);this.overlayLayer_.getSource().addFeature(f)}}else{var ext=this.feature_.getGeometry().getExtent();if(this.ispt_){var p=this.getMap().getPixelFromCoordinate([ext[0],ext[1]]);ext=ol.extent.boundingExtent([this.getMap().getCoordinateFromPixel([p[0]-10,p[1]-10]),this.getMap().getCoordinateFromPixel([p[0]+10,p[1]+10])])}var geom=ol.geom.Polygon.fromExtent(ext),f=this.bbox_=new ol.Feature(geom),features=[],g=geom.getCoordinates()[0];if(!this.ispt_){if(features.push(f),this.get("stretch")&&this.get("scale"))for(var i=0;i<g.length-1;i++)f=new ol.Feature({geometry:new ol.geom.Point([(g[i][0]+g[i+1][0])/2,(g[i][1]+g[i+1][1])/2]),handle:"scale",constraint:i%2?"h":"v",option:i}),features.push(f);if(this.get("scale"))for(var i=0;i<g.length-1;i++)f=new ol.Feature({geometry:new ol.geom.Point(g[i]),handle:"scale",option:i}),features.push(f);this.get("translate")&&!this.get("translateFeature")&&(f=new ol.Feature({geometry:new ol.geom.Point([(g[0][0]+g[2][0])/2,(g[0][1]+g[2][1])/2]),handle:"translate"}),features.push(f))}this.get("rotate")&&(f=new ol.Feature({geometry:new ol.geom.Point(g[3]),handle:"rotate"}),features.push(f)),this.overlayLayer_.getSource().addFeatures(features)}},ol.interaction.Transform.prototype.select=function(feature){this.feature_=feature,this.ispt_=!!this.feature_&&"Point"==this.feature_.getGeometry().getType(),this.drawSketch_(),this.dispatchEvent({type:"select",feature:this.feature_})},ol.interaction.Transform.prototype.handleDownEvent_=function(evt){var sel=this.getFeatureAtPixel_(evt.pixel),feature=sel.feature;return this.feature_&&this.feature_==feature&&(this.ispt_&&this.get("translate")||this.get("translateFeature"))&&(sel.handle="translate"),sel.handle?(this.mode_=sel.handle,this.opt_=sel.option,this.constraint_=sel.constraint,this.coordinate_=evt.coordinate,this.pixel_=evt.pixel,this.geom_=this.feature_.getGeometry().clone(),this.extent_=ol.geom.Polygon.fromExtent(this.geom_.getExtent()).getCoordinates()[0],this.center_=ol.extent.getCenter(this.geom_.getExtent()),this.angle_=Math.atan2(this.center_[1]-evt.coordinate[1],this.center_[0]-evt.coordinate[0]),this.dispatchEvent({type:this.mode_+"start",feature:this.feature_,pixel:evt.pixel,coordinate:evt.coordinate}),!0):(this.feature_=feature,this.ispt_=!!this.feature_&&"Point"==this.feature_.getGeometry().getType(),this.drawSketch_(),this.dispatchEvent({type:"select",feature:this.feature_,pixel:evt.pixel,coordinate:evt.coordinate}),!1)},ol.interaction.Transform.prototype.handleDragEvent_=function(evt){switch(this.mode_){case"rotate":var a=Math.atan2(this.center_[1]-evt.coordinate[1],this.center_[0]-evt.coordinate[0]);if(!this.ispt){var geometry=this.geom_.clone();geometry.rotate(a-this.angle_,this.center_),this.feature_.setGeometry(geometry)}this.drawSketch_(!0),this.dispatchEvent({type:"rotating",feature:this.feature_,angle:a-this.angle_,pixel:evt.pixel,coordinate:evt.coordinate});break;case"translate":var deltaX=evt.coordinate[0]-this.coordinate_[0],deltaY=evt.coordinate[1]-this.coordinate_[1];this.feature_.getGeometry().translate(deltaX,deltaY),this.handles_.forEach(function(f){f.getGeometry().translate(deltaX,deltaY)}),this.coordinate_=evt.coordinate,this.dispatchEvent({type:"translating",feature:this.feature_,delta:[deltaX,deltaY],pixel:evt.pixel,coordinate:evt.coordinate});break;case"scale":var center=this.center_;(evt.originalEvent.metaKey||evt.originalEvent.ctrlKey)&&(center=this.extent_[(Number(this.opt_)+2)%4]);var scx=(evt.coordinate[0]-center[0])/(this.coordinate_[0]-center[0]),scy=(evt.coordinate[1]-center[1])/(this.coordinate_[1]-center[1]);this.constraint_?"h"==this.constraint_?scx=1:scy=1:evt.originalEvent.shiftKey&&(scx=scy=Math.min(scx,scy));var geometry=this.geom_.clone();geometry.applyTransform(function(g1,g2,dim){if(dim<2)return g2;for(i=0;i<g1.length;i+=dim)1!=scx&&(g2[i]=center[0]+(g1[i]-center[0])*scx),1!=scy&&(g2[i+1]=center[1]+(g1[i+1]-center[1])*scy);return g2}),this.feature_.setGeometry(geometry),this.drawSketch_(),this.dispatchEvent({type:"scaling",feature:this.feature_,scale:[scx,scy],pixel:evt.pixel,coordinate:evt.coordinate})}},ol.interaction.Transform.prototype.handleMoveEvent_=function(evt){if(!this.mode_){var sel=(evt.map,this.getFeatureAtPixel_(evt.pixel)),element=evt.map.getTargetElement();if(sel.feature){var c=sel.handle?this.Cursors[(sel.handle||"default")+(sel.constraint||"")+(sel.option||"")]:this.Cursors.select;void 0===this.previousCursor_&&(this.previousCursor_=element.style.cursor),element.style.cursor=c}else void 0!==this.previousCursor_&&(element.style.cursor=this.previousCursor_),this.previousCursor_=void 0}},ol.interaction.Transform.prototype.handleUpEvent_=function(evt){return this.dispatchEvent({type:this.mode_+"end",feature:this.feature_,oldgeom:this.geom_}),this.drawSketch_(),this.mode_=null,!1},ol.filter={},ol.filter.Base=function(options){ol.Object.call(this),options&&options.active===!1?this.set("active",!1):this.set("active",!0)},ol.inherits(ol.filter.Base,ol.Object),ol.filter.Base.prototype.setActive=function(b){this.set("active",b===!0)},ol.filter.Base.prototype.getActive=function(b){return this.set("active")},ol.filter.Base.prototype.addFilter_=function(filter){this.filters_||(this.filters_=[]),this.filters_.push(filter),filter.precompose&&this.on("precompose",function(e){filter.get("active")&&filter.precompose(e)},this),filter.postcompose&&this.on("postcompose",function(e){filter.get("active")&&filter.postcompose(e)},this),filter.on("propertychange",function(){this.renderSync?this.renderSync():this.changed()},this)},ol.Map.prototype.addFilter=function(filter){ol.filter.Base.prototype.addFilter_.call(this,filter)},ol.Map.prototype.getFilters=function(){return this.filters_},ol.layer.Base.prototype.addFilter=function(filter){ol.filter.Base.prototype.addFilter_.call(this,filter)},ol.layer.Base.prototype.getFilters=function(){return this.filters_},ol.filter.Mask=function(options){if(options=options||{},ol.filter.Base.call(this,options),options.feature)switch(options.feature.getGeometry().getType()){case"Polygon":case"MultiPolygon":this.feature_=options.feature}this.set("inner",options.inner),this.fillColor_=options.fill?ol.color.asString(options.fill.getColor())||"rgba(0,0,0,0.2)":"rgba(0,0,0,0.2)"},ol.inherits(ol.filter.Mask,ol.filter.Base),ol.filter.Mask.prototype.drawFeaturePath_=function(e,out){function tr(pt){return[(pt[0]*m[0]+pt[1]*m[1]+m[4])*ratio,(pt[0]*m[2]+pt[1]*m[3]+m[5])*ratio]}var ctx=e.context,canvas=ctx.canvas,ratio=e.frameState.pixelRatio,m=e.frameState.coordinateToPixelTransform;m||(m=e.frameState.coordinateToPixelMatrix,tr=function(pt){return[(pt[0]*m[0]+pt[1]*m[1]+m[12])*ratio,(pt[0]*m[4]+pt[1]*m[5]+m[13])*ratio]});var ll=this.feature_.getGeometry().getCoordinates();"Polygon"==this.feature_.getGeometry().getType()&&(ll=[ll]),ctx.beginPath(),out&&(ctx.moveTo(0,0),ctx.lineTo(canvas.width,0),ctx.lineTo(canvas.width,canvas.height),ctx.lineTo(0,canvas.height),ctx.lineTo(0,0));for(var l=0;l<ll.length;l++)for(var c=ll[l],i=0;i<c.length;i++){var pt=tr(c[i][0]);ctx.moveTo(pt[0],pt[1]);for(var j=1;j<c[i].length;j++)pt=tr(c[i][j]),ctx.lineTo(pt[0],pt[1])}},ol.filter.Mask.prototype.postcompose=function(e){if(this.feature_){var ctx=e.context;ctx.save(),this.drawFeaturePath_(e,!this.get("inner")),ctx.fillStyle=this.fillColor_,ctx.fill("evenodd"),ctx.restore()}};