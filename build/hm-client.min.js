/*! Solr-Heatmap-Client created on 11-07-2016 */
angular.module("SolrHeatmapApp",["ui.bootstrap","rzModule"]),angular.module("SolrHeatmapApp").controller("BackgroundLayerController",["MapService","$scope",function(a,b){var c=this;c.layers={},c.selectedLayer={},c.$on("mapReady",function(a,b){c.layers=b.getLayers().getArray(),c.selectedLayer={name:c.getBackgroundLayers()[0].get("name")}}),c.isBackgroundLayer=function(a){var b=!1;return a.get("backgroundLayer")&&(b=!0),b},c.setBackgroundLayer=function(a){angular.forEach(c.getBackgroundLayers(),function(b){b===a?(a.setVisible(!0),c.selectedLayer={name:a.get("name")}):b.setVisible(!1)})},c.getBackgroundLayers=function(){var b=a.getMap().getLayers().getArray();return b.filter(function(a){return!!a.get("backgroundLayer")})}}]),angular.module("SolrHeatmapApp").controller("DatePickerController",["HeatMapSourceGenerator","$uibModal","$scope",function(a,b,c){var d=c;d.initialDateOptions={minDate:new Date("2000-01-01"),maxDate:new Date("2016-12-31")},d.dateString="[2000-01-01T00:00:00 TO 2016-12-31T00:00:00]",d.dateOptions={minDate:a.getSearchObj().minDate,maxDate:a.getSearchObj().maxDate,startingDay:1,showWeeks:!1},d.openStartDate=function(){d.startDate.opened=!0,d.dateOptions.minDate=d.initialDateOptions.minDate,d.dateOptions.maxDate=d.dte},d.openEndDate=function(){d.endDate.opened=!0,d.dateOptions.maxDate=d.initialDateOptions.maxDate,d.dateOptions.minDate=d.dts},d.startDate={opened:!1},d.endDate={opened:!1},d.setInitialDates=function(){d.dts=d.dateOptions.minDate,d.dte=d.dateOptions.maxDate},d.setInitialDates(),d.onChangeStartDate=function(){d.setDateRange(d.dts,d.dte),a.performSearch()},d.onChangeEndDate=function(){d.setDateRange(d.dts,d.dte),a.performSearch()},d.setDateRange=function(b,c){a.setMinDate(b),a.setMaxDate(c),d.dateString="["+b.toISOString().replace(".000Z","")+" TO "+c.toISOString().replace(".000Z","")+"]"},d.showInfo=function(){b.open({animation:!0,templateUrl:"infoPopup.html",controller:"InfoWindowController",size:"lg",resolve:{infoMsg:function(){return solrHeatmapApp.instructions.datepicker.instruction},toolName:function(){return solrHeatmapApp.instructions.datepicker.toolTitle}}})}}]),angular.module("SolrHeatmapApp").controller("ExportController",["HeatMapSourceGenerator","$uibModal","$scope",function(a,b,c){c["export"]={numDocuments:1,options:{floor:1,ceil:1e4,step:1}},c.startExport=function(){var b=c["export"].numDocuments;a.startCsvExport(b)},c.showInfo=function(){b.open({animation:!0,templateUrl:"infoPopup.html",controller:"InfoWindowController",size:"lg",resolve:{infoMsg:function(){return solrHeatmapApp.instructions["export"].instruction},toolName:function(){return solrHeatmapApp.instructions["export"].toolTitle}}})}}]),angular.module("SolrHeatmapApp").controller("GeospatialFilterController",["$scope","$uibModal",function(a,b){a.filterString="[-90,-180 TO 90,180]",a.showInfo=function(){b.open({animation:!0,templateUrl:"infoPopup.html",controller:"InfoWindowController",size:"lg",resolve:{infoMsg:function(){return solrHeatmapApp.instructions.geospatialsearch.instruction},toolName:function(){return solrHeatmapApp.instructions.geospatialsearch.toolTitle}}})},a.updateFilterString=function(b){a.filterString=b}}]),angular.module("SolrHeatmapApp").controller("InfoWindowController",function(a,b,c,d){a.infoMsg=c,a.toolName=d,a.ok=function(){b.close()}}),angular.module("SolrHeatmapApp").controller("MainController",["Map","HeatMapSourceGenerator","$http","$scope","$rootScope",function(a,b,c,d,e){var f=this;solrHeatmapApp=f,c.get("./config/appConfig.json").success(function(c,d,f,g){if(!c||!c.mapConfig)throw"Could not find the mapConfig";var h=c.mapConfig,i=c.appConfig,j=c.bopwsConfig,k=c.instructions;a.init({mapConfig:h}),solrHeatmapApp.appConfig=i,solrHeatmapApp.initMapConf=h,solrHeatmapApp.bopwsConfig=j,solrHeatmapApp.instructions=k,e.$broadcast("mapReady",a.getMap()),a.getMap().on("moveend",function(a){b.performSearch()}),a.getMap().getView().on("change:resolution",function(b){var c=a.getLayersBy("name","HeatMapLayer");if(c&&c.length>0){var d=500*b.target.getResolution(),e=c[0];d>15&&(d=15),e.setRadius(d),e.setBlur(2*d)}a.checkBoxOfTransformInteraction()}),a.getMap().on("moveend",function(a){b.performSearch()}),a.getInteractionsByClass(ol.interaction.Transform)[0].on(["translateend","scaleend"],function(a){b.performSearch()})}).error(function(a,b,c,d){throw"Error while loading the config.json"})}]),angular.module("SolrHeatmapApp").controller("ResultCounterController",["$scope",function(a){a.$on("setCounter",function(b,c){c<1&&(c="No results found"),a.counter=c})}]),angular.module("SolrHeatmapApp").controller("SearchController",["Map","HeatMapSourceGenerator","$scope","$uibModal","$controller","$window",function(a,b,c,d,e,f){function g(a){return f.event?a.keyCode:a.which}c.searchInput="",c.onKeyPress=function(a){13===g(a)&&c.doSearch()},c.doSearch=function(){b.setSearchText(c.searchInput),b.performSearch()},c.resetSearchInput=function(){c.searchInput="",b.setSearchText(""),b.performSearch(),a.resetMap();var d=c.$new();e("DatePickerController",{$scope:d}),d.setInitialDates()},c.showInfo=function(){d.open({animation:!0,templateUrl:"infoPopup.html",controller:"InfoWindowController",size:"lg",resolve:{infoMsg:function(){return solrHeatmapApp.instructions.textsearch.instruction},toolName:function(){return solrHeatmapApp.instructions.textsearch.toolTitle}}})}}]),angular.module("SolrHeatmapApp").controller("UserFilterController",["HeatMapSourceGenerator","$scope","$uibModal",function(a,b,c){b.showInfo=function(){c.open({animation:!0,templateUrl:"infoPopup.html",controller:"InfoWindowController",size:"lg",resolve:{infoMsg:function(){return solrHeatmapApp.instructions.userfilter.instruction},toolName:function(){return solrHeatmapApp.instructions.userfilter.toolTitle}}})}}]),angular.module("SolrHeatmapApp").factory("HeatMapSourceGenerator",["Map","$rootScope","$controller","$filter","$window","$document","$http",function(a,b,c,d,e,f,g){function h(a){w.searchText=a}function i(a){w.minDate=a}function j(a){w.maxDate=a}function k(){return w}function l(a,b,c){if(c<b){var d=b;b=c,c=d}return Math.min(Math.max(b,a),c)}function m(a){return a<-180||a>180}function n(a){return a<-90||a>90}function o(a){return l(a,-180,180)}function p(a){return l(a,-90,90)}function q(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=Math.min(d-b,360),g=Math.min(e-c,180);return m(b)?(b=o(b),d=b+f):m(d)&&(d=o(d),b=d-f),n(c)?(c=p(c),e=c+g):n(e)&&(e=p(e),c=e-g),[b,c,d,e]}function r(){var b,d,e=a.getMap(),f=e.getView().getProjection().getCode(),g=e.getView().calculateExtent(e.getSize()),h=ol.proj.transformExtent(g,f,"EPSG:4326"),i=a.getLayersBy("name","TransformInteractionLayer")[0],j={};if(!i)return null;if(b=i.getSource().getFeatures()[0],d=ol.proj.transformExtent(b.getGeometry().getExtent(),f,"EPSG:4326"),e.getView().getZoom()<=1&&(h=[-180,-90,180,90]),g&&h){var k=q(h),l=q(d),m=k[1],n=k[3],o=k[0],p=k[2];j.hmFilter={minX:m,maxX:n,minY:o,maxY:p},m=l[1],n=l[3],o=l[0],p=l[2],j.queryGeo={minX:m,maxX:n,minY:o,maxY:p};var r=angular.element("[ng-controller=GeospatialFilterController]").scope();c("GeospatialFilterController",{$scope:r}),r.updateFilterString("["+parseFloat(Math.round(100*m)/100).toFixed(2)+","+parseFloat(Math.round(100*o)/100).toFixed(2)+" TO "+parseFloat(Math.round(100*n)/100).toFixed(2)+","+parseFloat(Math.round(100*p)/100).toFixed(2)+"]")}return j}function s(){var c={},d=this.getGeospatialFilter(),f=this.getTweetsSearchQueryParameters(d.queryGeo,d.hmFilter);f["a.hm.limit"]=solrHeatmapApp.bopwsConfig.heatmapFacetLimit,f&&null!==d?(c={url:solrHeatmapApp.appConfig.tweetsSearchBaseUrl,method:"GET",params:f},g(c).success(function(c,d,e,f){c&&c["a.hm"]&&(a.createOrUpdateHeatMapLayer(c["a.hm"]),b.$broadcast("setCounter",c["a.matchDocs"]))}).error(function(a,b,c,d){e.alert("An error occured while reading heatmap data")})):e.alert("Spatial filter could not be computed.")}function t(){var a={},b=this.getGeospatialFilter(),c=this.getTweetsSearchQueryParameters(b.queryGeo,b.hmFilter);c["d.docs.limit"]=solrHeatmapApp.bopwsConfig.csvDocsLimit,c&&null!==b?(a={url:solrHeatmapApp.appConfig.tweetsExportBaseUrl,method:"GET",params:c},g(a).success(function(a,b,c,d){var e=angular.element("<a/>");e.css({display:"none"}),angular.element(f.body).append(e),e.attr({href:"data:attachment/csv;charset=utf-8,"+encodeURI(a),target:"_blank",download:"bop_export.csv"})[0].click(),e.remove()}).error(function(a,b,c,d){e.alert("An error occured while exporting csv data")})):e.alert("Spatial filter could not be computed.")}function u(a){var b,c=this.getSearchObj();b=0===c.searchText.length?"*":c.searchText;var d=a.maxX-a.minX,e=a.maxY-a.minY,f=a.minX+(1-solrHeatmapApp.appConfig.ratioInnerBbox)*d,g=a.minX+solrHeatmapApp.appConfig.ratioInnerBbox*d,h=a.minY+(1-solrHeatmapApp.appConfig.ratioInnerBbox)*e,i=a.minY+solrHeatmapApp.appConfig.ratioInnerBbox*e,j={"q.text":b,"q.time":"["+this.getFormattedDateString(c.minDate)+" TO "+this.getFormattedDateString(c.maxDate)+"]","q.geo":"["+a.minX+","+a.minY+" TO "+a.maxX+","+a.maxY+"]","a.hm.filter":"["+f+","+h+" TO "+g+","+i+"]"};return j}function v(a){return a.getFullYear()+"-"+("0"+(a.getMonth()+1)).slice(-2)+"-"+("0"+a.getDate()).slice(-2)}var w={minDate:new Date("2000-01-01"),maxDate:new Date("2016-12-31"),searchText:""},x={getGeospatialFilter:r,getTweetsSearchQueryParameters:u,performSearch:s,startCsvExport:t,setSearchText:h,setMinDate:i,setMaxDate:j,getFormattedDateString:v,getSearchObj:k};return x}]),angular.module("SolrHeatmapApp").factory("Map",["$rootScope","$filter","$document",function(a,b,c){function d(a){var b,c=[];return angular.isArray(a)&&angular.forEach(a,function(a){"TileWMS"===a.type&&(b=new ol.layer.Tile({name:a.name,backgroundLayer:a.backgroundLayer,displayInLayerPanel:a.displayInLayerPanel,source:new ol.source.TileWMS({attributions:[new ol.Attribution({html:a.attribution})],crossOrigin:a.crossOrigin,logo:a.logo,params:a.params,ratio:a.ratio,resolutions:a.resoltions,url:a.url}),opacity:a.opacity,visible:a.visible})),"ImageWMS"===a.type&&(b=new ol.layer.Image({name:a.name,backgroundLayer:a.backgroundLayer,displayInLayerPanel:a.displayInLayerPanel,source:new ol.source.ImageWMS({attributions:[new ol.Attribution({html:a.attribution})],crossOrigin:a.crossOrigin,logo:a.logo,params:a.params,resolutions:a.resoltions,url:a.url}),opacity:a.opacity,visible:a.visible})),c.push(b)}),c}function e(){return t}function f(a,c){var d=e().getLayers().getArray();return b("filter")(d,function(b){return b.get(a)===c})}function g(a){var c=e().getInteractions().getArray();return b("filter")(c,function(b){return b instanceof a})}function h(a,c){return b("filter")(a,function(a){return a.type_===c})}function i(b){var d=b.coordinate,e=t.forEachFeatureAtPixel(b.pixel,function(a,b){return a}),f="",g=c[0].getElementById("popup"),h=c[0].getElementById("popup-content"),i=c[0].getElementById("popup-closer"),j=new ol.Overlay({element:g,autoPan:!0,autoPanAnimation:{duration:250}});if(i.onclick=function(){return j.setPosition(void 0),i.blur(),!1},t.getOverlays().clear(),t.addOverlay(j),e){var k=e.get("origVal");k&&a.$broadcast("featureInfoLoaded",k)}v.$on("featureInfoLoaded",function(a,b){f+="<h5>Number of elements: </h5>"+k,h.innerHTML=f;var c=solrHeatmapApp.map.getOverlays().getArray()[0];c&&c.setPosition(d)})}function j(a){var b=f("name","HeatMapLayer")[0],c=b.getFilters()[0],d=f("backgroundLayer",!0)[0],e=d.getFilters()[0];e.setActive(!a),c.setActive(a)}function k(a,b,c){for(var d=-1,e=Number.MAX_VALUE,f=0;f<b;f++){var g=a[f];null===g&&(a[f]=g=[]);for(var h=0;h<c;h++)null===g[h]&&(g[h]=-1),g[h]>d&&(d=g[h]),g[h]<e&&g[h]>-1&&(e=g[h])}return[e,d]}function l(a,b){return null===a?0:a===-1?-1:0===a?0:b[1]-b[0]===0?0:(a-b[0])/(b[1]-b[0])}function m(a){var b,c,d=a.counts_ints2D,e=(a.gridLevel,a.columns),f=a.rows,g=a.minX,h=a.minY,i=a.maxX,j=a.maxY,m=a.projection,n=i-g,o=j-h,p=n/e,q=o/f,r=[];if(!d)return null;b=k(d,f,e);for(var s=0;s<f;s++)for(var u=0;u<e;u++){var v,w,x,y,z=d[d.length-s-1][u];if(z&&null!==z){w=h+s*q+.5*q,v=g+u*p+.5*p,y=ol.proj.transform([v,w],m,t.getView().getProjection().getCode()),x=new ol.Feature({geometry:new ol.geom.Point(y)});var A=l(z,b);x.set("weight",A),x.set("origVal",z),r.push(x)}}return c=new ol.source.Vector({features:r,useSpatialIndex:!0})}function n(a){var b,c=m(a),d=f("name","HeatMapLayer"),e=f("name","TransformInteractionLayer")[0];if(d&&d.length>0){var g=d[0],h=g.getSource();h&&h.clear(),g.setSource(c)}else{b=new ol.layer.Heatmap({name:"HeatMapLayer",source:c,radius:10}),t.addLayer(b);var i=e.getSource().getFeatures()[0],k=new ol.filter.Mask({feature:i,inner:!1,fill:new ol.style.Fill({color:[255,255,255,.5]})});b.addFilter(k)}j(null!==c)}function o(a){var b,c=f("name","TransformInteractionLayer")[0],d=c.getSource(),e=d.getFeatures()[0];b=ol.geom.Polygon.fromExtent(a),e.setGeometry(b),t.getInteractions().getArray().forEach(function(a){a instanceof ol.interaction.Transform&&a.dispatchEvent("propertychange")})}function p(a,b){var c=new ol.Feature(ol.geom.Polygon.fromExtent(a)),d=f("backgroundLayer",!0)[0];f("name","HeatMapLayer")[0];if(b!==t.getView().getProjection().getCode()){var e=ol.proj.transformExtent(a,b,t.getView().getProjection().getCode());c=new ol.Feature(ol.geom.Polygon.fromExtent(e))}var g=new ol.layer.Vector({name:"TransformInteractionLayer",source:new ol.source.Vector,style:new ol.style.Style({fill:new ol.style.Fill({color:[255,255,255,.01]})})});t.addLayer(g),g.getSource().addFeature(c);var h=new ol.interaction.Transform({translate:!0,scale:!0,translateFeature:!1,rotate:!1,stretch:!1});t.addInteraction(h);var i=new ol.filter.Mask({feature:c,inner:!1,fill:new ol.style.Fill({color:[255,255,255,.5]})});d.addFilter(i)}function q(){for(var a=f("name","TransformInteractionLayer")[0],b=t.getView().calculateExtent(t.getSize()),c=a.getSource(),d=c.getFeatures()[0],e=!1,g=d.getGeometry().getCoordinates()[0],h=0;h<g.length;h++)if(!new ol.geom.Point(g[h]).intersectsExtent(b)){e=!0;break}if(e===!0){var i=b[0],j=b[1],k=b[2],l=b[3],m=k-i,n=l-j,p=i+(1-solrHeatmapApp.appConfig.ratioInnerBbox)*m,q=i+solrHeatmapApp.appConfig.ratioInnerBbox*m,r=j+(1-solrHeatmapApp.appConfig.ratioInnerBbox)*n,s=j+solrHeatmapApp.appConfig.ratioInnerBbox*n;o([p,r,q,s])}}function r(){var a=solrHeatmapApp.initMapConf.view.center,b=solrHeatmapApp.initMapConf.view.zoom;if(b&&a){var c=t.getView();c.setCenter(a),c.setZoom(b),o(solrHeatmapApp.initMapConf.view.extent)}}function s(a){var b=angular.extend(u.view,a.mapConfig.view),c=angular.extend(u.renderer,a.mapConfig.renderer),e=a.mapConfig.layers;if(t=new ol.Map({controls:ol.control.defaults().extend([new ol.control.ScaleLine,new ol.control.ZoomSlider]),interactions:ol.interaction.defaults(),layers:d(e),renderer:angular.isString(c)?c:void 0,target:"map",view:new ol.View({center:angular.isArray(b.center)?b.center:void 0,maxZoom:angular.isNumber(b.maxZoom)?b.maxZoom:void 0,minZoom:angular.isNumber(b.minZoom)?b.minZoom:void 0,projection:angular.isString(b.projection)?b.projection:void 0,resolution:angular.isString(b.resolution)?b.resolution:void 0,resolutions:angular.isArray(b.resolutions)?b.resolutions:void 0,rotation:angular.isNumber(b.rotation)?b.rotation:void 0,zoom:angular.isNumber(b.zoom)?b.zoom:void 0,zoomFactor:angular.isNumber(b.zoomFactor)?b.zoomFactor:void 0})}),angular.isArray(b.extent)){var f=t.getView();f.set("extent",b.extent),p(b.extent,b.projection)}}var t={},u={renderer:"canvas",view:{center:[0,0],projection:"EPSG:3857",zoom:2}},v=a,w={init:s,getMap:e,getLayersBy:f,getInteractionsByClass:g,getInteractionsByType:h,displayFeatureInfo:i,createOrUpdateHeatMapLayer:n,generateMaskAndAssociatedInteraction:p,checkBoxOfTransformInteraction:q,setTransactionBBox:o,createHeatMapSource:m,heatmapMinMax:k,rescaleHeatmapValue:l,resetMap:r};return w}]),ol.interaction.Transform=function(a){a||(a={});var b=this;ol.interaction.Pointer.call(this,{handleDownEvent:this.handleDownEvent_,handleDragEvent:this.handleDragEvent_,handleMoveEvent:this.handleMoveEvent_,handleUpEvent:this.handleUpEvent_}),this.features_=a.features,this.layers_=a.layers?a.layers instanceof Array?a.layers:[a.layers]:null,this.set("translateFeature",a.translateFeature!==!1),this.set("translate",a.translate!==!1),this.set("stretch",a.stretch!==!1),this.set("scale",a.scale!==!1),this.set("rotate",a.rotate!==!1),this.on("propertychange",function(){this.drawSketch_()}),this.handles_=new ol.Collection,this.overlayLayer_=new ol.layer.Vector({source:new ol.source.Vector({features:this.handles_,useSpatialIndex:!1}),name:"Transform overlay",displayInLayerSwitcher:!1,style:function(a){return b.style[(a.get("handle")||"default")+(a.get("constraint")||"")+(a.get("option")||"")]}}),this.setDefaultStyle()},ol.inherits(ol.interaction.Transform,ol.interaction.Pointer),ol.interaction.Transform.prototype.Cursors={"default":"auto",select:"pointer",translate:"move",rotate:"move",scale:"ne-resize",scale1:"nw-resize",scale2:"ne-resize",scale3:"nw-resize",scalev:"e-resize",scaleh1:"n-resize",scalev2:"e-resize",scaleh3:"n-resize"},ol.interaction.Transform.prototype.setMap=function(a){this.getMap()&&this.getMap().removeLayer(this.overlayLayer_),ol.interaction.Pointer.prototype.setMap.call(this,a),this.overlayLayer_.setMap(a),this.isTouch=/touch/.test(a.getViewport().className),this.setDefaultStyle()},ol.interaction.Transform.prototype.setActive=function(a){ol.interaction.Pointer.prototype.setActive.call(this,a),a&&this.select(null)},ol.interaction.Transform.prototype.setDefaultStyle=function(){function a(a,b,c){return[new ol.style.Style({image:a,stroke:b,fill:c})]}var b=new ol.style.Stroke({color:[255,0,0,1],width:1}),c=new ol.style.Stroke({color:[255,0,0,1],width:1,lineDash:[4,4]}),d=new ol.style.Fill({color:[255,0,0,.01]}),e=new ol.style.Fill({color:[255,255,255,.8]}),f=new ol.style.RegularShape({fill:e,stroke:b,radius:this.isTouch?12:6,points:15});f.getAnchor()[0]=this.isTouch?-10:-5;var g=new ol.style.RegularShape({fill:e,stroke:b,radius:this.isTouch?16:8,points:4,angle:Math.PI/4}),h=new ol.style.RegularShape({fill:e,stroke:b,radius:this.isTouch?12:6,points:4,angle:Math.PI/4});this.style={"default":a(g,c,d),translate:a(g,b,e),rotate:a(f,b,e),rotate0:a(g,b,e),scale:a(g,b,e),scale1:a(g,b,e),scale2:a(g,b,e),scale3:a(g,b,e),scalev:a(h,b,e),scaleh1:a(h,b,e),scalev2:a(h,b,e),scaleh3:a(h,b,e)},this.drawSketch_()},ol.interaction.Transform.prototype.setStyle=function(a,b){if(b){b instanceof Array?this.style[a]=b:this.style[a]=[b];for(var c=0;c<this.style[a].length;c++){var d=this.style[a][c].getImage();d&&("rotate"==a&&(d.getAnchor()[0]=-5),this.isTouch&&d.setScale(1.8));var e=this.style[a][c].getText();e&&("rotate"==a&&e.setOffsetX(this.isTouch?14:7),this.isTouch&&e.setScale(1.8))}this.drawSketch_()}},ol.interaction.Transform.prototype.getFeatureAtPixel_=function(a){return this.getMap().forEachFeatureAtPixel(a,function(a,b){var c=!1;if(!b){if(a===this.bbox_)return!1;if(this.handles_.forEach(function(b){b===a&&(c=!0)}),c)return{feature:a,handle:a.get("handle"),constraint:a.get("constraint"),option:a.get("option")}}if(this.layers_){for(var d=0;d<this.layers_.length;d++)if(this.layers_[d]===b)return{feature:a};return null}return this.features_?(this.features_.forEach(function(b){b===a&&(c=!0)}),c?{feature:a}:null):{feature:a}},this)||{}},ol.interaction.Transform.prototype.drawSketch_=function(a){if(this.overlayLayer_.getSource().clear(),this.feature_)if(a===!0){if(!this.ispt_){this.overlayLayer_.getSource().addFeature(new ol.Feature({geometry:new ol.geom.Point(this.center_),handle:"rotate0"}));var b=this.feature_.getGeometry().getExtent(),c=ol.geom.Polygon.fromExtent(b),d=this.bbox_=new ol.Feature(c);this.overlayLayer_.getSource().addFeature(d)}}else{var b=this.feature_.getGeometry().getExtent();if(this.ispt_){var e=this.getMap().getPixelFromCoordinate([b[0],b[1]]);b=ol.extent.boundingExtent([this.getMap().getCoordinateFromPixel([e[0]-10,e[1]-10]),this.getMap().getCoordinateFromPixel([e[0]+10,e[1]+10])])}var c=ol.geom.Polygon.fromExtent(b),d=this.bbox_=new ol.Feature(c),f=[],g=c.getCoordinates()[0];if(!this.ispt_){if(f.push(d),this.get("stretch")&&this.get("scale"))for(var h=0;h<g.length-1;h++)d=new ol.Feature({geometry:new ol.geom.Point([(g[h][0]+g[h+1][0])/2,(g[h][1]+g[h+1][1])/2]),handle:"scale",constraint:h%2?"h":"v",option:h}),f.push(d);if(this.get("scale"))for(var h=0;h<g.length-1;h++)d=new ol.Feature({geometry:new ol.geom.Point(g[h]),handle:"scale",option:h}),f.push(d);this.get("translate")&&!this.get("translateFeature")&&(d=new ol.Feature({geometry:new ol.geom.Point([(g[0][0]+g[2][0])/2,(g[0][1]+g[2][1])/2]),handle:"translate"}),f.push(d))}this.get("rotate")&&(d=new ol.Feature({geometry:new ol.geom.Point(g[3]),handle:"rotate"}),f.push(d)),this.overlayLayer_.getSource().addFeatures(f)}},ol.interaction.Transform.prototype.select=function(a){this.feature_=a,this.ispt_=!!this.feature_&&"Point"==this.feature_.getGeometry().getType(),this.drawSketch_(),this.dispatchEvent({type:"select",feature:this.feature_})},ol.interaction.Transform.prototype.handleDownEvent_=function(a){var b=this.getFeatureAtPixel_(a.pixel),c=b.feature;return this.feature_&&this.feature_==c&&(this.ispt_&&this.get("translate")||this.get("translateFeature"))&&(b.handle="translate"),b.handle?(this.mode_=b.handle,this.opt_=b.option,this.constraint_=b.constraint,this.coordinate_=a.coordinate,this.pixel_=a.pixel,this.geom_=this.feature_.getGeometry().clone(),this.extent_=ol.geom.Polygon.fromExtent(this.geom_.getExtent()).getCoordinates()[0],this.center_=ol.extent.getCenter(this.geom_.getExtent()),this.angle_=Math.atan2(this.center_[1]-a.coordinate[1],this.center_[0]-a.coordinate[0]),this.dispatchEvent({type:this.mode_+"start",feature:this.feature_,pixel:a.pixel,coordinate:a.coordinate}),!0):(this.feature_=c,this.ispt_=!!this.feature_&&"Point"==this.feature_.getGeometry().getType(),this.drawSketch_(),this.dispatchEvent({type:"select",feature:this.feature_,pixel:a.pixel,coordinate:a.coordinate}),!1)},ol.interaction.Transform.prototype.handleDragEvent_=function(a){switch(this.mode_){case"rotate":var b=Math.atan2(this.center_[1]-a.coordinate[1],this.center_[0]-a.coordinate[0]);if(!this.ispt){var c=this.geom_.clone();c.rotate(b-this.angle_,this.center_),this.feature_.setGeometry(c)}this.drawSketch_(!0),this.dispatchEvent({type:"rotating",feature:this.feature_,angle:b-this.angle_,pixel:a.pixel,coordinate:a.coordinate});break;case"translate":var d=a.coordinate[0]-this.coordinate_[0],e=a.coordinate[1]-this.coordinate_[1];this.feature_.getGeometry().translate(d,e),this.handles_.forEach(function(a){a.getGeometry().translate(d,e)}),this.coordinate_=a.coordinate,this.dispatchEvent({type:"translating",feature:this.feature_,delta:[d,e],pixel:a.pixel,coordinate:a.coordinate});break;case"scale":var f=this.center_;(a.originalEvent.metaKey||a.originalEvent.ctrlKey)&&(f=this.extent_[(Number(this.opt_)+2)%4]);var g=(a.coordinate[0]-f[0])/(this.coordinate_[0]-f[0]),h=(a.coordinate[1]-f[1])/(this.coordinate_[1]-f[1]);this.constraint_?"h"==this.constraint_?g=1:h=1:a.originalEvent.shiftKey&&(g=h=Math.min(g,h));var c=this.geom_.clone();c.applyTransform(function(a,b,c){if(c<2)return b;for(i=0;i<a.length;i+=c)1!=g&&(b[i]=f[0]+(a[i]-f[0])*g),1!=h&&(b[i+1]=f[1]+(a[i+1]-f[1])*h);return b}),this.feature_.setGeometry(c),this.drawSketch_(),this.dispatchEvent({type:"scaling",feature:this.feature_,scale:[g,h],pixel:a.pixel,coordinate:a.coordinate})}},ol.interaction.Transform.prototype.handleMoveEvent_=function(a){if(!this.mode_){var b=(a.map,this.getFeatureAtPixel_(a.pixel)),c=a.map.getTargetElement();if(b.feature){var d=b.handle?this.Cursors[(b.handle||"default")+(b.constraint||"")+(b.option||"")]:this.Cursors.select;void 0===this.previousCursor_&&(this.previousCursor_=c.style.cursor),c.style.cursor=d}else void 0!==this.previousCursor_&&(c.style.cursor=this.previousCursor_),this.previousCursor_=void 0}},ol.interaction.Transform.prototype.handleUpEvent_=function(a){return this.dispatchEvent({type:this.mode_+"end",feature:this.feature_,oldgeom:this.geom_}),this.drawSketch_(),this.mode_=null,!1},ol.filter={},ol.filter.Base=function(a){ol.Object.call(this),a&&a.active===!1?this.set("active",!1):this.set("active",!0)},ol.inherits(ol.filter.Base,ol.Object),ol.filter.Base.prototype.setActive=function(a){this.set("active",a===!0)},ol.filter.Base.prototype.getActive=function(a){return this.set("active")},ol.filter.Base.prototype.addFilter_=function(a){this.filters_||(this.filters_=[]),this.filters_.push(a),a.precompose&&this.on("precompose",function(b){a.get("active")&&a.precompose(b)},this),a.postcompose&&this.on("postcompose",function(b){a.get("active")&&a.postcompose(b)},this),a.on("propertychange",function(){this.renderSync?this.renderSync():this.changed()},this)},ol.Map.prototype.addFilter=function(a){ol.filter.Base.prototype.addFilter_.call(this,a)},ol.Map.prototype.getFilters=function(){return this.filters_},ol.layer.Base.prototype.addFilter=function(a){ol.filter.Base.prototype.addFilter_.call(this,a)},ol.layer.Base.prototype.getFilters=function(){return this.filters_},ol.filter.Mask=function(a){if(a=a||{},ol.filter.Base.call(this,a),a.feature)switch(a.feature.getGeometry().getType()){case"Polygon":case"MultiPolygon":this.feature_=a.feature}this.set("inner",a.inner),this.fillColor_=a.fill?ol.color.asString(a.fill.getColor())||"rgba(0,0,0,0.2)":"rgba(0,0,0,0.2)"},ol.inherits(ol.filter.Mask,ol.filter.Base),ol.filter.Mask.prototype.drawFeaturePath_=function(a,b){function c(a){return[(a[0]*g[0]+a[1]*g[1]+g[12])*f,(a[0]*g[4]+a[1]*g[5]+g[13])*f]}var d=a.context,e=d.canvas,f=a.frameState.pixelRatio,g=a.frameState.coordinateToPixelMatrix,h=this.feature_.getGeometry().getCoordinates();"Polygon"==this.feature_.getGeometry().getType()&&(h=[h]),d.beginPath(),b&&(d.moveTo(0,0),d.lineTo(e.width,0),d.lineTo(e.width,e.height),d.lineTo(0,e.height),d.lineTo(0,0));for(var i=0;i<h.length;i++)for(var j=h[i],k=0;k<j.length;k++){var l=c(j[k][0]);d.moveTo(l[0],l[1]);for(var m=1;m<j[k].length;m++)l=c(j[k][m]),d.lineTo(l[0],l[1])}},ol.filter.Mask.prototype.postcompose=function(a){if(this.feature_){var b=a.context;b.save(),this.drawFeaturePath_(a,!this.get("inner")),b.fillStyle=this.fillColor_,b.fill("evenodd"),b.restore()}};